import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime, timedelta
import random

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="An√°lise de Cr√©dito Inteligente",
    page_icon="üí≥",
    layout="wide"
)

# Menu principal no sidebar
st.sidebar.title("üè¶ Menu Principal")
pagina_selecionada = st.sidebar.selectbox(
    "Escolha uma op√ß√£o:",
    [
        "üè† P√°gina Inicial",
        "üí≥ An√°lise de Cr√©dito",
        "üìä Dashboard Financeiro",
        "üìà Simulador de Investimentos",
        "üéØ Planejamento Financeiro",
        "üìö Educa√ß√£o Financeira",
        "‚öôÔ∏è Configura√ß√µes"
    ]
)

# ===== P√ÅGINA INICIAL =====
def pagina_inicial():
    st.title("üè¶ Bem-vindo √† Plataforma Financeira Completa")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.info("""
        ### üí≥ An√°lise de Cr√©dito
        Avalie seu perfil de cr√©dito de forma r√°pida e inteligente
        """)
    
    with col2:
        st.success("""
        ### üìä Dashboard Financeiro
        Visualize suas finan√ßas em tempo real
        """)
    
    with col3:
        st.warning("""
        ### üìà Simulador de Investimentos
        Simule diferentes cen√°rios de investimento
        """)
    
    st.markdown("---")
    
    # Estat√≠sticas gerais
    col4, col5, col6, col7 = st.columns(4)
    
    with col4:
        st.metric("Usu√°rios Ativos", "1,234", "+12%")
    
    with col5:
        st.metric("An√°lises Realizadas", "5,678", "+8%")
    
    with col6:
        st.metric("Taxa de Aprova√ß√£o", "73%", "+2%")
    
    with col7:
        st.metric("Satisfa√ß√£o", "4.8/5", "+0.2")
    
    # Gr√°fico de exemplo
    st.subheader("üìà Tend√™ncias do Mercado")
    
    # Dados simulados
    dates = pd.date_range(start='2024-01-01', end='2024-12-31', freq='M')
    aprovacoes = np.random.normal(100, 15, len(dates)).cumsum()
    
    fig = px.line(
        x=dates, 
        y=aprovacoes,
        title="Evolu√ß√£o de Aprova√ß√µes de Cr√©dito",
        labels={'x': 'M√™s', 'y': 'N√∫mero de Aprova√ß√µes'}
    )
    st.plotly_chart(fig, use_container_width=True)

# ===== AN√ÅLISE DE CR√âDITO (p√°gina original) =====
def analise_credito():
    st.title("üí≥ An√°lise de Cr√©dito Inteligente")
    st.markdown("### An√°lise inteligente de risco de cr√©dito baseada em suas respostas")

    # Informa√ß√µes do usu√°rio
    st.subheader("üìã Informa√ß√µes do Solicitante")
    
    col_info1, col_info2 = st.columns(2)
    
    with col_info1:
        nome = st.text_input("Nome completo:")
        idade = st.slider("Idade:", 18, 80, 30)
    
    with col_info2:
        renda = st.number_input("Renda mensal (R$):", min_value=0.0, value=3000.0, step=100.0)
        estado_civil = st.selectbox("Estado Civil:", ["Solteiro(a)", "Casado(a)", "Divorciado(a)", "Vi√∫vo(a)"])

    # Se√ß√£o principal - Perguntas interativas
    st.header("ü§î Responda as perguntas abaixo:")

    col1, col2 = st.columns(2)

    with col1:
        st.subheader("Situa√ß√£o Profissional")
        emprego_estavel = st.radio(
            "Voc√™ tem emprego est√°vel h√° mais de 2 anos?",
            ["Sim", "N√£o"],
            key="emprego"
        )
        
        carteira_assinada = st.radio(
            "Trabalha com carteira assinada?",
            ["Sim", "N√£o"],
            key="carteira"
        )
        
        renda_extra = st.radio(
            "Possui renda extra?",
            ["Sim", "N√£o"],
            key="renda_extra"
        )

    with col2:
        st.subheader("Hist√≥rico Financeiro")
        nome_limpo = st.radio(
            "Seu nome est√° limpo nos √≥rg√£os de prote√ß√£o (SPC/Serasa)?",
            ["Sim", "N√£o"],
            key="nome_limpo"
        )
        
        conta_bancaria = st.radio(
            "Possui conta banc√°ria h√° mais de 1 ano?",
            ["Sim", "N√£o"],
            key="conta"
        )
        
        cartao_credito = st.radio(
            "Usa cart√£o de cr√©dito regularmente sem atrasos?",
            ["Sim", "N√£o"],
            key="cartao"
        )

    # Mais perguntas
    st.subheader("Situa√ß√£o Patrimonial e Compromissos")

    col3, col4 = st.columns(2)

    with col3:
        imovel_proprio = st.radio(
            "Possui im√≥vel pr√≥prio?",
            ["Sim", "N√£o"],
            key="imovel"
        )
        
        veiculo_proprio = st.radio(
            "Possui ve√≠culo pr√≥prio?",
            ["Sim", "N√£o"],
            key="veiculo"
        )

    with col4:
        dividas_pendentes = st.radio(
            "Possui d√≠vidas pendentes?",
            ["Sim", "N√£o"],
            key="dividas"
        )
        
        dependentes = st.radio(
            "Possui dependentes financeiros?",
            ["Sim", "N√£o"],
            key="dependentes"
        )

    # Valor solicitado
    st.subheader("üí∞ Cr√©dito Solicitado")
    valor_credito = st.number_input(
        "Valor do cr√©dito solicitado (R$):",
        min_value=100.0,
        max_value=100000.0,
        value=5000.0,
        step=500.0
    )

    # Bot√£o para an√°lise
    if st.button("üîç Realizar An√°lise de Cr√©dito", type="primary"):
        
        # [C√≥digo da an√°lise permanece o mesmo...]
        # Calculando score baseado nas respostas
        score = 300  # Score base
        
        # Pontua√ß√£o baseada em renda
        if renda >= 5000:
            score += 150
        elif renda >= 3000:
            score += 100
        elif renda >= 1500:
            score += 50
        
        # Pontua√ß√£o baseada na idade
        if 25 <= idade <= 55:
            score += 50
        elif idade > 55:
            score += 30
        
        # Pontua√ß√£o baseada nas respostas
        respostas_positivas = {
            emprego_estavel: 80,
            carteira_assinada: 60,
            renda_extra: 40,
            nome_limpo: 100,
            conta_bancaria: 50,
            cartao_credito: 70,
            imovel_proprio: 60,
            veiculo_proprio: 30
        }
        
        respostas_negativas = {
            dividas_pendentes: -80,
            dependentes: -20
        }
        
        for resposta, pontos in respostas_positivas.items():
            if resposta == "Sim":
                score += pontos
        
        for resposta, pontos in respostas_negativas.items():
            if resposta == "Sim":
                score += pontos
        
        # Ajuste baseado no valor solicitado vs renda
        if valor_credito > renda * 5:
            score -= 50
        elif valor_credito > renda * 3:
            score -= 30
        
        # Limitando o score entre 300 e 850
        score = max(300, min(850, score))
        
        # Determinando aprova√ß√£o
        if score >= 650:
            status = "APROVADO"
            cor_status = "green"
            taxa_juros = max(0.8, 3.5 - (score - 650) / 100)
        elif score >= 500:
            status = "PR√â-APROVADO"
            cor_status = "orange"
            taxa_juros = max(1.5, 5.0 - (score - 500) / 100)
        else:
            status = "NEGADO"
            cor_status = "red"
            taxa_juros = 0
        
        # Exibindo resultados
        st.markdown("---")
        st.header("üìä Resultado da An√°lise")
        
        col_result1, col_result2, col_result3 = st.columns(3)
        
        with col_result1:
            st.metric(
                "Score de Cr√©dito",
                f"{score}",
                delta=f"{score - 600}" if score > 600 else f"{score - 600}"
            )
        
        with col_result2:
            st.markdown(f"**Status:** <span style='color: {cor_status}; font-size: 24px;'>{status}</span>", 
                       unsafe_allow_html=True)
        
        with col_result3:
            if status != "NEGADO":
                st.metric("Taxa de Juros", f"{taxa_juros:.1f}% a.m.")
        
        # [Resto do c√≥digo da an√°lise...]

# ===== DASHBOARD FINANCEIRO =====
def dashboard_financeiro():
    st.title("üìä Dashboard Financeiro")
    
    # M√©tricas principais
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("Saldo Total", "R$ 12.450", "+R$ 850")
    with col2:
        st.metric("Gastos do M√™s", "R$ 3.200", "-R$ 150")
    with col3:
        st.metric("Economia", "R$ 1.800", "+R$ 200")
    with col4:
        st.metric("Investimentos", "R$ 8.500", "+R$ 350")
    
    # Gr√°ficos
    col_chart1, col_chart2 = st.columns(2)
    
    with col_chart1:
        # Gr√°fico de gastos por categoria
        categorias = ['Alimenta√ß√£o', 'Transporte', 'Lazer', 'Sa√∫de', 'Educa√ß√£o']
        valores = [800, 450, 300, 200, 150]
        
        fig_pizza = px.pie(
            values=valores, 
            names=categorias,
            title="Gastos por Categoria"
        )
        st.plotly_chart(fig_pizza, use_container_width=True)
    
    with col_chart2:
        # Gr√°fico de evolu√ß√£o mensal
        meses = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun']
        receitas = [4000, 4200, 3800, 4500, 4100, 4300]
        gastos = [3200, 3100, 2900, 3400, 3000, 3200]
        
        fig_linha = go.Figure()
        fig_linha.add_trace(go.Scatter(x=meses, y=receitas, name='Receitas'))
        fig_linha.add_trace(go.Scatter(x=meses, y=gastos, name='Gastos'))
        fig_linha.update_layout(title="Evolu√ß√£o Financeira")
        
        st.plotly_chart(fig_linha, use_container_width=True)
    
    # Tabela de transa√ß√µes recentes
    st.subheader("üí∏ Transa√ß√µes Recentes")
    
    transacoes = pd.DataFrame({
        'Data': ['2024-06-14', '2024-06-13', '2024-06-12', '2024-06-11'],
        'Descri√ß√£o': ['Supermercado XYZ', 'Combust√≠vel', 'Netflix', 'Sal√°rio'],
        'Categoria': ['Alimenta√ß√£o', 'Transporte', 'Lazer', 'Receita'],
        'Valor': [-250.80, -120.00, -29.90, 4500.00]
    })
    
    st.dataframe(transacoes, use_container_width=True)

# ===== SIMULADOR DE INVESTIMENTOS =====
def simulador_investimentos():
    st.title("üìà Simulador de Investimentos")
    
    col_sim1, col_sim2 = st.columns([1, 2])
    
    with col_sim1:
        st.subheader("Par√¢metros da Simula√ß√£o")
        
        valor_inicial = st.number_input("Valor inicial (R$):", min_value=100.0, value=1000.0)
        aporte_mensal = st.number_input("Aporte mensal (R$):", min_value=0.0, value=200.0)
        taxa_anual = st.slider("Taxa de juros anual (%):", 1.0, 20.0, 8.0, 0.5)
        periodo_anos = st.slider("Per√≠odo (anos):", 1, 30, 10)
        
        tipo_investimento = st.selectbox(
            "Tipo de investimento:",
            ["Poupan√ßa", "CDB", "Tesouro Direto", "A√ß√µes", "Fundos"]
        )
    
    with col_sim2:
        # Simula√ß√£o
        meses = periodo_anos * 12
        taxa_mensal = (1 + taxa_anual/100) ** (1/12) - 1
        
        valores = [valor_inicial]
        for mes in range(1, meses + 1):
            valor_anterior = valores[-1]
            novo_valor = (valor_anterior + aporte_mensal) * (1 + taxa_mensal)
            valores.append(novo_valor)
        
        # Gr√°fico de crescimento
        meses_lista = list(range(0, meses + 1))
        
        fig_investimento = px.line(
            x=meses_lista,
            y=valores,
            title=f"Proje√ß√£o de Investimento - {tipo_investimento}",
            labels={'x': 'Meses', 'y': 'Valor (R$)'}
        )
        st.plotly_chart(fig_investimento, use_container_width=True)
        
        # Resultados
        valor_final = valores[-1]
        valor_investido = valor_inicial + (aporte_mensal * meses)
        rendimento = valor_final - valor_investido
        
        col_res1, col_res2, col_res3 = st.columns(3)
        
        with col_res1:
            st.metric("Valor Final", f"R$ {valor_final:,.2f}")
        with col_res2:
            st.metric("Total Investido", f"R$ {valor_investido:,.2f}")
        with col_res3:
            st.metric("Rendimento", f"R$ {rendimento:,.2f}")

# ===== PLANEJAMENTO FINANCEIRO =====
def planejamento_financeiro():
    st.title("üéØ Planejamento Financeiro")
    
    st.subheader("üí∞ Definir Metas Financeiras")
    
    tab1, tab2, tab3 = st.tabs(["Metas de Curto Prazo", "Metas de M√©dio Prazo", "Metas de Longo Prazo"])
    
    with tab1:
        st.write("### Objetivos para os pr√≥ximos 2 anos")
        
        col1, col2 = st.columns(2)
        with col1:
            meta_curto = st.text_input("Descri√ß√£o da meta:", placeholder="Ex: Comprar um carro")
            valor_meta_curto = st.number_input("Valor necess√°rio (R$):", min_value=0.0, value=30000.0)
        
        with col2:
            prazo_curto = st.slider("Prazo (meses):", 1, 24, 12)
            valor_mensal_curto = valor_meta_curto / prazo_curto if prazo_curto > 0 else 0
            st.metric("Valor mensal necess√°rio", f"R$ {valor_mensal_curto:.2f}")
    
    with tab2:
        st.write("### Objetivos para 2-10 anos")
        
        col1, col2 = st.columns(2)
        with col1:
            meta_medio = st.text_input("Descri√ß√£o da meta:", placeholder="Ex: Comprar um im√≥vel", key="meta_medio")
            valor_meta_medio = st.number_input("Valor necess√°rio (R$):", min_value=0.0, value=200000.0, key="valor_medio")
        
        with col2:
            prazo_medio = st.slider("Prazo (anos):", 2, 10, 5, key="prazo_medio")
            valor_mensal_medio = valor_meta_medio / (prazo_medio * 12) if prazo_medio > 0 else 0
            st.metric("Valor mensal necess√°rio", f"R$ {valor_mensal_medio:.2f}")
    
    with tab3:
        st.write("### Objetivos para aposentadoria")
        
        col1, col2 = st.columns(2)
        with col1:
            idade_atual = st.number_input("Idade atual:", 18, 65, 30)
            idade_aposentadoria = st.number_input("Idade para aposentar:", idade_atual + 1, 80, 60)
            
        with col2:
            renda_desejada = st.number_input("Renda mensal desejada (R$):", min_value=1000.0, value=5000.0)
            anos_restantes = idade_aposentadoria - idade_atual
            
            # C√°lculo simplificado
            valor_total_necessario = renda_desejada * 12 * 25  # 25 anos de aposentadoria
            valor_mensal_aposentadoria = valor_total_necessario / (anos_restantes * 12) if anos_restantes > 0 else 0
            
            st.metric("Anos restantes", f"{anos_restantes} anos")
            st.metric("Valor mensal necess√°rio", f"R$ {valor_mensal_aposentadoria:.2f}")

# ===== EDUCA√á√ÉO FINANCEIRA =====
def educacao_financeira():
    st.title("üìö Educa√ß√£o Financeira")
    
    # Dicas financeiras
    st.subheader("üí° Dicas de Educa√ß√£o Financeira")
    
    dicas = [
        {
            "titulo": "üìù Controle seus gastos",
            "conteudo": "Anote todos os seus gastos durante um m√™s para entender para onde vai seu dinheiro."
        },
        {
            "titulo": "üéØ Estabele√ßa metas",
            "conteudo": "Defina objetivos claros e prazos realistas para suas conquistas financeiras."
        },
        {
            "titulo": "üè¶ Construa uma reserva de emerg√™ncia",
            "conteudo": "Mantenha de 3 a 6 meses de gastos guardados para imprevistos."
        },
        {
            "titulo": "üìà Invista regularmente",
            "conteudo": "Mesmo pequenos valores investidos mensalmente fazem diferen√ßa no longo prazo."
        }
    ]
    
    for dica in dicas:
        with st.expander(dica["titulo"]):
            st.write(dica["conteudo"])
    
    # Calculadora de juros compostos
    st.subheader("üßÆ Calculadora de Juros Compostos")
    
    col_calc1, col_calc2 = st.columns(2)
    
    with col_calc1:
        principal = st.number_input("Capital inicial (R$):", value=1000.0, min_value=0.0)
        taxa = st.number_input("Taxa de juros anual (%):", value=10.0, min_value=0.0)
        tempo = st.number_input("Tempo (anos):", value=5, min_value=1)
    
    with col_calc2:
        montante = principal * (1 + taxa/100) ** tempo
        juros = montante - principal
        
        st.metric("Montante final", f"R$ {montante:,.2f}")
        st.metric("Juros ganhos", f"R$ {juros:,.2f}")
        st.metric("Crescimento", f"{((montante/principal - 1) * 100):.1f}%")

# ===== CONFIGURA√á√ïES =====
def configuracoes():
    st.title("‚öôÔ∏è Configura√ß√µes")
    
    st.subheader("üë§ Perfil do Usu√°rio")
    
    col_config1, col_config2 = st.columns(2)
    
    with col_config1:
        nome_usuario = st.text_input("Nome:", value="Jo√£o Silva")
        email_usuario = st.text_input("E-mail:", value="joao@email.com")
        telefone_usuario = st.text_input("Telefone:", value="(11) 99999-9999")
    
    with col_config2:
        notificacoes = st.checkbox("Receber notifica√ß√µes por e-mail", value=True)
        newsletter = st.checkbox("Receber newsletter semanal", value=False)
        modo_escuro = st.checkbox("Modo escuro", value=False)
    
    st.subheader("üîê Seguran√ßa")
    
    if st.button("Alterar senha"):
        st.info("Funcionalidade em desenvolvimento")
    
    if st.button("Salvar configura√ß√µes", type="primary"):
        st.success("Configura√ß√µes salvas com sucesso!")

# ===== ROTEAMENTO DAS P√ÅGINAS =====
if pagina_selecionada == "üè† P√°gina Inicial":
    pagina_inicial()
elif pagina_selecionada == "üí≥ An√°lise de Cr√©dito":
    analise_credito()
elif pagina_selecionada == "üìä Dashboard Financeiro":
    dashboard_financeiro()
elif pagina_selecionada == "üìà Simulador de Investimentos":
    simulador_investimentos()
elif pagina_selecionada == "üéØ Planejamento Financeiro":
    planejamento_financeiro()
elif pagina_selecionada == "üìö Educa√ß√£o Financeira":
    educacao_financeira()
elif pagina_selecionada == "‚öôÔ∏è Configura√ß√µes":
    configuracoes()

# Footer
st.sidebar.markdown("---")
st.sidebar.markdown("""
<div style='text-align: center; color: gray; font-size: 12px;'>
    üí≥ Plataforma Financeira Completa<br>
    Vers√£o 2.0
</div>
""", unsafe_allow_html=True)
